# ctld-agent Configuration Reference
# ===================================
#
# ctld-agent is configured via /etc/rc.conf variables, not this file.
# This file documents the available options and provides examples.
#
# Required /etc/rc.conf settings:
#
#   ctld_agent_enable="YES"
#   ctld_agent_zfs_parent="tank/csi"       # REQUIRED: Parent ZFS dataset
#
# Optional /etc/rc.conf settings:
#
#   # Network
#   ctld_agent_listen="[::1]:50051"        # Localhost only (default)
#   ctld_agent_listen="[::]:50051"         # All interfaces (for external access)
#   ctld_agent_listen="0.0.0.0:50051"      # IPv4 only
#
#   # iSCSI Configuration
#   ctld_agent_base_iqn="iqn.2024-01.org.freebsd.csi"
#   ctld_agent_portal_group="pg0"
#   ctld_agent_ctl_config="/etc/ctl.conf"
#
#   # NVMeoF Configuration (FreeBSD 15+)
#   ctld_agent_base_nqn="nqn.2024-01.org.freebsd.csi"
#   ctld_agent_transport_group="tg0"
#
#   # TLS/mTLS (for secure gRPC)
#   ctld_agent_tls_cert="/usr/local/etc/ctld-agent/server.crt"
#   ctld_agent_tls_key="/usr/local/etc/ctld-agent/server.key"
#   ctld_agent_tls_client_ca="/usr/local/etc/ctld-agent/ca.crt"
#
#   # Logging
#   ctld_agent_log_level="info"
#   ctld_agent_logfile="/var/log/ctld-agent.log"
#
#   # Additional flags
#   ctld_agent_flags=""
#
# ===================================
# CTL Configuration (/etc/ctl.conf)
# ===================================
#
# ctld-agent manages iSCSI/NVMeoF targets via a separate config file.
# CSI-managed targets are written to: /var/db/ctld-agent/csi-targets.conf
#
# Your /etc/ctl.conf should include this file via .include directive.
#
# Example /etc/ctl.conf:
#
# auth-group {
#     ag0 {
#         auth-type = none
#     }
# }
#
# portal-group {
#     pg0 {
#         discovery-auth-group = no-authentication
#         listen = "0.0.0.0:3260"
#     }
# }
#
# # For NVMeoF (FreeBSD 15.0+)
# transport-group {
#     tg0 {
#         discovery-auth-group = no-authentication
#         listen {
#             tcp = "0.0.0.0:4420"
#         }
#     }
# }
#
# # Include CSI-managed targets
# .include "/var/db/ctld-agent/csi-targets.conf"
#
# ===================================
# CHAP Authentication (Optional)
# ===================================
#
# For CHAP authentication, modify the auth-group:
#
# auth-group {
#     ag0 {
#         auth-type = chap
#         chap = "username" "secret"
#     }
# }
#
# Or for mutual CHAP:
#
# auth-group {
#     ag0 {
#         auth-type = chap-mutual
#         chap = "initiator-user" "initiator-secret"
#         chap-mutual = "target-user" "target-secret"
#     }
# }
#
# ===================================
# Multiple Portal Groups (Advanced)
# ===================================
#
# portal-group {
#     pg0 {
#         discovery-auth-group = no-authentication
#         listen = "192.168.1.10:3260"
#     }
#     pg1 {
#         discovery-auth-group = no-authentication
#         listen = "10.0.0.10:3260"
#     }
# }
#
# ===================================
# Setup Steps
# ===================================
#
# 1. Create the CSI targets directory:
#    mkdir -p /var/db/ctld-agent
#    touch /var/db/ctld-agent/csi-targets.conf
#
# 2. Create /etc/ctl.conf with portal/transport groups and .include
#
# 3. Enable services in /etc/rc.conf:
#    ctld_enable="YES"
#    ctld_agent_enable="YES"
#    ctld_agent_zfs_parent="tank/csi"
#
# 4. Start services:
#    service ctld start
#    service ctld_agent start
#
# ===================================
# Kubernetes Integration
# ===================================
#
# The CSI driver connects to ctld-agent via gRPC. Configure the
# driver with the agent endpoint:
#
#   --agent-endpoint=http://192.168.1.10:50051
#
# For mTLS:
#   --agent-endpoint=https://192.168.1.10:50051
#   --tls-cert=/path/to/client.crt
#   --tls-key=/path/to/client.key
#   --tls-ca=/path/to/ca.crt
#
# ===================================
# Troubleshooting
# ===================================
#
# Check service status:
#   service ctld_agent status
#
# View logs:
#   tail -f /var/log/ctld-agent.log
#
# Test gRPC connectivity:
#   grpcurl -plaintext localhost:50051 list
#
# Check CTL status:
#   ctladm portlist
#   ctladm lunlist
#
# Check ZFS volumes:
#   zfs list -r tank/csi
#
# Check CSI-managed config:
#   cat /var/db/ctld-agent/csi-targets.conf
