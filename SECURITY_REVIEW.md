# Security Review: CHAP Authentication Implementation

**Date:** 2026-01-24
**Reviewer:** polecat/rust
**Scope:** PRs #1, #2, #3 (CHAP authentication implementation)

## Executive Summary

The CHAP authentication implementation follows security best practices for credential handling. Secrets are properly isolated in `/etc/ctl.conf` (root-only) and are not stored in ZFS metadata. One medium-severity finding was identified related to input validation.

## Findings

### PASS: Credential Storage Architecture

| Check | Status | Notes |
|-------|--------|-------|
| No secrets in ZFS properties | ✅ PASS | Only auth-group NAME stored, not credentials |
| Secrets in /etc/ctl.conf | ✅ PASS | Root-only file, proper permissions |
| No secrets logged | ✅ PASS | Logging uses field names only, not values |
| Debug trait on auth types | ✅ PASS | Not used in tracing/logging statements |

**Evidence:**
- `ctld-agent/src/zfs/properties.rs:14-16`: Clear documentation that credentials are NOT stored in ZFS
- `ctld-agent/src/service/storage.rs:501-502`: Comment confirms only auth-group NAME stored
- `csi-driver/src/controller.rs:191-194`: Debug logs show `username=%` and `has_mutual=` but not actual secrets

### PASS: Path Traversal Protection

| Check | Status | Notes |
|-------|--------|-------|
| DevicePath validation | ✅ PASS | Rejects `..` sequences |
| Node service path check | ✅ PASS | `csi-driver/src/node.rs:83-85` |

### PASS: OWASP Top 10 - Broken Authentication

| Check | Status | Notes |
|-------|--------|-------|
| CHAP implementation | ✅ PASS | Uses standard iSCSI CHAP mechanism |
| Mutual CHAP support | ✅ PASS | Bidirectional authentication supported |
| Auth-group isolation | ✅ PASS | Each volume gets its own auth-group |

### PASS: Dependency Audit

```
cargo audit: 0 vulnerabilities found (236 dependencies scanned)
```

### PASS: Test Coverage

| Test Category | Count | Coverage |
|---------------|-------|----------|
| Unit tests (auth types) | 14 | IscsiChapAuth, NvmeAuth, AuthConfig |
| Unit tests (UCL config) | 14 | Auth-group generation, serialization |
| E2E tests (CHAP) | 10+ | Full workflow, edge cases |

**Key E2E Tests:**
- `test_chap_volume_creation`: Basic CHAP flow
- `test_mutual_chap_volume_creation`: Mutual authentication
- `test_missing_chap_secret_fails`: Negative test
- `test_special_characters_in_chap_password`: Special char handling
- `test_volume_cleanup_removes_auth_group`: Cleanup verification

### FINDING: UCL Input Validation Not Applied

**Severity:** Medium
**Type:** Input Validation Gap
**File:** `ctld-agent/src/ctl/ucl_config.rs`

**Description:**
The `validate_ucl_string` function (lines 610-637) correctly rejects dangerous characters (`"`, `{`, `}`, `\`) but is marked `#[allow(dead_code)]` and never called for CHAP credentials.

**Impact:**
If a user provides a CHAP password containing `"` (e.g., `pass"word`), the generated UCL would be malformed:
```
chap "username" "pass"word";  # Malformed UCL
```

This could cause:
1. ctld configuration parsing failure (DoS)
2. Potential (unlikely) UCL syntax injection

**Recommendation:**
Call `validate_ucl_string` on CHAP username and secret before passing to `ucl_quote`, OR implement proper UCL escaping in `ucl_quote`.

**Mitigating Factors:**
- K8s Secret values are typically base64-decoded, not user-editable
- UCL parsing failure is visible (not silent)
- E2E test `test_special_characters_in_chap_password` exercises this path

## Files Reviewed

- `ctld-agent/src/ctl/ucl_config.rs` - Auth-group UCL generation
- `ctld-agent/src/ctl/types.rs` - IscsiChapAuth, NvmeAuth, AuthConfig types
- `ctld-agent/src/zfs/properties.rs` - VolumeMetadata (no secrets)
- `ctld-agent/src/service/storage.rs` - Credential flow, GroupRef pattern
- `csi-driver/src/controller.rs` - Secret extraction from CSI
- `e2e-tests/tests/test_07_chap_authentication.py` - CHAP E2E tests

## Recommendations

1. **Medium Priority**: Wire up `validate_ucl_string` for CHAP credentials, or implement proper UCL escaping
2. **Low Priority**: Consider adding integration test for malformed credential handling
3. **Informational**: Document the security architecture in SECURITY.md for operators

## Sign-off

The CHAP authentication implementation is **APPROVED** with one medium-severity finding that should be addressed in a future PR.

The credential storage architecture is sound:
- ZFS stores only references (auth-group names)
- Credentials exist only in `/etc/ctl.conf` (root-protected)
- No credential exposure in logs or error messages

---
*Generated by security review automation*
